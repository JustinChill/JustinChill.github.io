<!DOCTYPE html>
<html lang="en">
<head>
  <title>World's Oldest Person Since 1955</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="World's Oldest Person Since 1955.">
  <meta name="author" content="Justin Chill">

  <style type="text/css">
  article > figure{
    /*grid-column: 4;*/
    min-width: 0;
    margin: 0;
  }
  #oldest_legend{
   margin-top: 20px;
   background: hsl(216, 33%, 97%);
   padding-left: 10px;
   padding-bottom: 10px;
  }
  .plot text{
    font-size: 12px;
  }
  figcaption, figcaption > a {
    margin-bottom: 0;
    font-size: calc(8px + (22 - 16) * ((100vw - 320px) / (1300 - 320)));
    text-align: right;
  }
  ul > li {
    position: relative;
    padding-left: 1em;
    list-style: none;
    text-align: left;
  }
  ul > li:before{
    content: "";
    position: absolute;
    background-color: #cbd5e0;
    border-radius: 50%;
    width: .375em;
    height: .375em;
    top: .6875em;
    left: .25em;
  }
</style>
</head>
<body>
  <nav class="nav">
    <div class="nav__list">
      <a href="index.html" class="nav__item">Home</a>
      <a href="blog.html" class="nav__item">Blog</a>
      <a href="fun.html" class="nav__item">Fun</a>
    </div>
    <div class="nav__list">
      <a href="http://linkedin.com/in/justinrichardhill/" class="nav__item" target="_blank">LinkedIn</a>
      <a href="#" class="nav__item js-email-link">Email</a>
    </div>
  </nav>
  
  <main role="main">
    <article>
       <div class="article-hero">
        <h2 class="article-category">Post</h2>
        <h1 class="article-title">Corrosive Corruption</h1>
        <h2 class="article-subtitle"></h2>
      </div>

    <h3>Corruption and human development</h3>
    <figcaption id="corruption_legend"></figcaption>
    <figure id="corruption"></figure>
    <figcaption>Data: <a href="https://www.economist.com/graphic-detail/2011/12/02/corrosive-corruption">The Economist</a></figcaption>

    <p>Transparency International's annual Corruption Perceptions Index measures the perceived levels of public-sector graft (using one's political position for personal gain) by aggregating independent surveys from across the globe. Comparing the corruption index with the UN's Human Development Index (a measure combining health, wealth and education) demonstrates an interesting connection. As the corruption index rises beyond 4.0 a strong connection with the human development index can be seen. Notable outliers include small but well-run poorer countries such as Bhutan and Cape Verde, while Greece and Italy stand out among the richer countries.</p>

    <h3>Original graphic</h3>
    <img src="https://cdn.static-economist.com/sites/default/files/20111210_WOC210.gif">

</article>
</main>
<footer>
  <h2 id="footnote-label">Footnotes</h2>
  <ol>

  </ol>
  <div>
    <p>Justin Chill © 2021. Thanks for reading!</p>
    <p><a href="https://github.com/JustinChill/JustinChill.github.io" target="_blank"><img src="imgs/github.svg" class="gh">Source code and feedback</a></p>    
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.2"></script>

<script type="text/javascript">
  // Color Legend
  // https://observablehq.com/@d3/color-legend
  function legend(d,{
    color,
    title,
    tickSize = 6,
    width = 550,
    height = 44 + tickSize,
    marginTop = 18,
    marginRight = 0,
    marginBottom = 16 + tickSize,
    marginLeft = 0,
    ticks = width / 64,
    tickFormat,
    tickValues
  } = {}) {
    const svg = d3.select(d).append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", [0, 0, width, height])
      .style("overflow", "visible")
      .style("display", "block");

    let tickAdjust = g => g.selectAll(".tick line").attr("y1", marginTop + marginBottom - height);
    let x;

    // Continuous
    if (color.interpolate) {
      const n = Math.min(color.domain().length, color.range().length);

      x = color.copy().rangeRound(d3.quantize(d3.interpolate(marginLeft, width - marginRight), n));

      svg.append("image")
        .attr("x", marginLeft)
        .attr("y", marginTop)
        .attr("width", width - marginLeft - marginRight)
        .attr("height", height - marginTop - marginBottom)
        .attr("preserveAspectRatio", "none")
        .attr("xlink:href", ramp(color.copy().domain(d3.quantize(d3.interpolate(0, 1), n))).toDataURL());
    }

    // Sequential
    else if (color.interpolator) {
      x = Object.assign(color.copy()
        .interpolator(d3.interpolateRound(marginLeft, width - marginRight)), {
          range() {
            return [marginLeft, width - marginRight];
          }
        });

      svg.append("image")
        .attr("x", marginLeft)
        .attr("y", marginTop)
        .attr("width", width - marginLeft - marginRight)
        .attr("height", height - marginTop - marginBottom)
        .attr("preserveAspectRatio", "none")
        .attr("xlink:href", ramp(color.interpolator()).toDataURL());

      // scaleSequentialQuantile doesn’t implement ticks or tickFormat.
      if (!x.ticks) {
        if (tickValues === undefined) {
          const n = Math.round(ticks + 1);
          tickValues = d3.range(n).map(i => d3.quantile(color.domain(), i / (n - 1)));
        }
        if (typeof tickFormat !== "function") {
          tickFormat = d3.format(tickFormat === undefined ? ",f" : tickFormat);
        }
      }
    }

    // Threshold
    else if (color.invertExtent) {
      const thresholds = color.thresholds ? color.thresholds() // scaleQuantize
        :
        color.quantiles ? color.quantiles() // scaleQuantile
        :
        color.domain(); // scaleThreshold

      const thresholdFormat = tickFormat === undefined ? d => d :
        typeof tickFormat === "string" ? d3.format(tickFormat) :
        tickFormat;

      x = d3.scaleLinear()
        .domain([-1, color.range().length - 1])
        .rangeRound([marginLeft, width - marginRight]);

      svg.append("g")
        .selectAll("rect")
        .data(color.range())
        .join("rect")
        .attr("x", (d, i) => x(i - 1))
        .attr("y", marginTop)
        .attr("width", (d, i) => x(i) - x(i - 1))
        .attr("height", height - marginTop - marginBottom)
        .attr("fill", d => d);

      tickValues = d3.range(thresholds.length);
      tickFormat = i => thresholdFormat(thresholds[i], i);
    }

    // Ordinal
    else {
      x = d3.scaleBand()
        .domain(color.domain())
        .rangeRound([marginLeft, width - marginRight]);

      // svg.append("g")
      //   .selectAll("rect")
      //   .data(color.domain())
      //   .join("rect")
      //   .attr("x", x)
      //   .attr("y", marginTop)
      //   .attr("width", Math.max(0, x.bandwidth() - 1))
      //   .attr("height", height - marginTop - marginBottom)
      //   .attr("fill", color);

      svg.append("g")
        .selectAll("circle")
        .data(color.domain())
        .join("circle")
        .attr("cx", x)
        .attr("cy", marginTop)
        .attr("r", 5)
        // .attr("width", Math.max(0, x.bandwidth() - 1))
        // .attr("height", height - marginTop - marginBottom)
        .attr("stroke", color)
        .attr("fill", "#fff");

      tickAdjust = () => {};
    }

    svg.append("g")
      .attr("transform", `translate(0,${height - marginBottom})`)
      .call(d3.axisBottom(x)
        .ticks(ticks, typeof tickFormat === "string" ? tickFormat : undefined)
        .tickFormat(typeof tickFormat === "function" ? tickFormat : undefined)
        .tickSize(tickSize)
        .tickValues(tickValues))
      .call(tickAdjust)
      .call(g => g.select(".domain").remove())
      .call(g => g.append("text")
        .attr("x", marginLeft)
        .attr("y", marginTop + marginBottom - height - 6)
        .attr("fill", "currentColor")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text(title));

    return svg.node();
  }

  function ramp(color, n = 256) {
    var canvas = document.createElement('canvas');
    canvas.width = n;
    canvas.height = 1;
    const context = canvas.getContext("2d");
    for (let i = 0; i < n; ++i) {
      context.fillStyle = color(i / (n - 1));
      context.fillRect(i, 0, 1, 1);
    }
    return canvas;
  };

  function linearRegression(y,x){
          var lr = {};
          var n = y.length;
          var sum_x = 0;
          var sum_y = 0;
          var sum_xy = 0;
          var sum_xx = 0;
          var sum_yy = 0;

          for (var i = 0; i < y.length; i++) {

              sum_x += x[i];
              sum_y += y[i];
              sum_xy += (x[i]*y[i]);
              sum_xx += (x[i]*x[i]);
              sum_yy += (y[i]*y[i]);
          } 

          lr['slope'] = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
          lr['intercept'] = (sum_y - lr.slope * sum_x)/n;
          lr['r2'] = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);

          return lr;
  };
  var known_y = [1, 2, 3, 4];
  var known_x = [5.2, 5.7, 5.0, 4.2];

  var lr = linearRegression(known_y, known_x);
  console.log(lr);

  var element = d3.select('figure').node();
  var width = element.getBoundingClientRect().width; // get width of article so graphic is responsive
  var size = 12;
  var labels = ["Venezuela", "Iraq", "Myanmar", "Sudan",
               "Afghanistan", "Congo", "Greece", "Argentina", 
               "India", "Italy",
               "Botswana", "Cape Verde", "Bhutan", "Rwanda", "France",
               "United States",  "Britain", "Barbados", "Norway", 
               "New Zealand", "Singapore","Russia","Brazil","Spain","Germany", "Japan","China","South Africa"];

  // Use Promises to async request data
  var promises = [d3.csv("https://raw.githubusercontent.com/alokkshukla/RGraphics/master/dataSets/EconomistData.csv",d3.autoType)];
  myDataPromises = Promise.all(promises);

  // After data is successfully fetched, generate viz
  myDataPromises.then(function(data) {
    
    // Define the data
    var data = data[0];

    var corruption = {
      inset: 10,
      width: width,
      marginBottom: 40,
      marginLeft: 50,
      style:{fontSize: size},
      x: {
        label: "Corruption Perceptions Index, 2011 (10 = least corrupt)",
        labelAnchor: "center",
        labelOffset: 40,
        nice: true,
      },
      y: {
        label: "Human Development Index (1 = best)",
        labelAnchor: "center",
        labelOffset: 50,
        tickSize: 0,
        grid: true,
        domain: [.2, 1],
      },
      style: {
        background: "hsl(0, 0%, 99%)",
        // color: "white"
      },
      color: {
        scheme: "tableau10",
        reverse: true,
      },
      marks: [
      // I'm ashamed of this hack to get the r2 line
      // Plot.lineY([.28, .44, .56, .64, .72, .79, .83, .85, .88, .9], {
      //   stroke: "red",
      //   strokeWidth: 2,
      //   curve: "natural",
      // }),
        Plot.dot(data, {
          x: "CPI",
          y: "HDI",
          fill: null,
          stroke: "Region",
          fill: "white",
          r: 5,
          title: d => `${d.Country}\nCPI: ${d.CPI}\nHDI: ${d.HDI}`,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Venezuela"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -4,
          dx: -33,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Iraq"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 2,
          dx: -18,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Myanmar"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -10,
          dx: -14,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Sudan"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -10,
          dx: -14,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Afghanistan"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 18,
          dx: -14,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Congo"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 15,
          dx: -14,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Greece"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 2,
          dx: -26,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Argentina"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -6,
          dx: -30,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "India"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 6,
          dx: 20,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Italy"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -11,
          dx: -5,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Botswana"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 4,
          dx: 35,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Cape Verde"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 4,
          dx: 40,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Bhutan"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 5,
          dx: 26,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Rwanda"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 5,
          dx: 30,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "France"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 5,
          dx: -26,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "United States"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -10,
          dx: -35,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Britain"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 14,
          dx: 0,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Barbados"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 8,
          dx: 34,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Norway"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -10,
          dx: 3,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "New Zealand"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -10,
          dx: 33,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Singapore"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: 18,
          dx: 28,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Russia"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -9,
          dx: -10,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Brazil"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -7,
          dx: -2,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Spain"), {
          x: "CPI",
          y: "HDI",          
          text: "Country",
          dy: -9,
          dx: -3,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Germany"), {
          x: "CPI",
          y: "HDI",          
          text: d => `${d.Country}݈ `,
          dy: -10,
          dx: -25,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "Japan"), {
          x: "CPI",
          y: "HDI",          
          text: d => `${d.Country}`,
          dy: -8,
          dx: 18,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "China"), {
          x: "CPI",
          y: "HDI",          
          text: d => `↖${d.Country}`,
          dy: 17,
          dx: 25,
        }),
        Plot.text(data.filter(d => labels.includes(d.Country) & d.Country == "South Africa"), {
          x: "CPI",
          y: "HDI",          
          text: d => `${d.Country}`,
          dy: 17,
          dx: 20,
        }),
      ]
    };

    var mycolor = Plot.plot(corruption).scale("color");
    console.log(mycolor); // it works! 

    var corruption_legend = {
      color: d3.scaleOrdinal(mycolor.domain, mycolor.range),
      title: mycolor.label,
      // tickFormat: d => d === "SSA" ? `South Saharan` : `${d}`,
      tickSize: 0,
    };

    document.getElementById("corruption").appendChild(Plot.plot(corruption));
    document.getElementById("corruption_legend").appendChild(legend("#corruption_legend",corruption_legend));
  });
  </script>
</body>
</html>