<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
    <title>Market Heatmap | Justin Chill</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Create your own interactive market heatmap. Compare companies on market and execution strength, export high-quality quadrant charts, and customize your analysis.">
    <meta name="author" content="Justin Chill">

    <!-- OpenGraph tags -->
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="JustinChill">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Market Heatmap | Justin Chill">
    <meta property="og:description"
        content="Create your own interactive market heatmap. Compare companies on market and execution strength, export high-quality quadrant charts, and customize your analysis.">
    <meta property="og:url" content="https://justinchill.com/heatmap.html">
    <meta property="og:image" content="https://justinchill.com/imgs/heatmap_cover.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@JustinChill">
    <meta name="twitter:creator" content="@JustinChill">
    <meta name="twitter:title" content="Market Heatmap | Justin Chill">
    <meta name="twitter:description"
        content="Create your own interactive market heatmap. Compare companies on market and execution strength, export high-quality quadrant charts, and customize your analysis.">

    <link rel="icon" href="/favicon.ico">
    <meta name="theme-color" content="#4C63B6">

    <!-- styles -->
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">


    <script type="module">
        document.documentElement.classList.remove('no-js');
        document.documentElement.classList.add('js');
    </script>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

    <style>
        /* CSS Variables & Utilities */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --primary-color: #4f46e5;
            /* Indigo 600 */
            --primary-hover: #4338ca;
            /* Indigo 700 */
            --danger-color: #ef4444;
            /* Red 500 */
            --success-color: #16a34a;
            /* Green 600 */
            --gray-color: #6b7280;
            /* Gray 500 */
            --border-color: #e5e7eb;
            /* Gray 200 */
        }

        body {
            background: #fdfdfd;
            min-height: 100vh;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.25rem;
        }

        header.header-center {
            text-align: center;
            max-width: 42rem;
            margin: 0 auto 2.5rem;
        }

        .heatmap-figure {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Components */
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 100%;
            position: relative;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
        }

        .chart-container {
            width: 100%;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .export-btn-container {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 10;
        }

        /* Icons */
        .icon {
            width: 1.5rem;
            height: 1.5rem;
        }

        .icon-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-icon-only {
            padding: 0.5rem;
        }

        .btn-white {
            background-color: #ffffff;
            color: #374151;
            border-color: #d1d5db;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-white:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: #9ca3af;
        }

        .btn-ghost:hover {
            color: var(--primary-color);
        }

        .btn-ghost.delete-btn:hover {
            color: var(--danger-color);
        }

        /* Forms */
        .form-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .form-content {
            margin-top: 1rem;
            display: none;
        }

        .form-content.visible {
            display: block;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-color);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.25rem;
        }

        input[type="text"],
        input[type="number"] {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            font-size: 0.875rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Table */
        .data-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
        }

        .data-actions {
            display: flex;
            gap: 0.5rem;
        }

        .data-list {
            overflow-y: auto;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 1rem;
        }

        .data-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            background: white;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item:hover {
            box-shadow: none;
            background-color: #f9fafb;
        }

        .data-item-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .company-avatar {
            width: 3rem;
            height: 3rem;
            min-width: 3rem;
            border-radius: 0.5rem;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .company-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            padding: 0;
        }

        .company-details p.name {
            font-weight: 600;
            color: #111827;
            font-size: 0.95rem;
            margin: 0;
        }

        .company-details p.stats {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0.125rem 0 0 0;
        }

        .item-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .relative {
            position: relative;
        }

        .absolute {
            position: absolute;
        }

        .w-full {
            width: 100%;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        /* Autocomplete */
        .autocomplete-dropdown {
            position: absolute;
            z-index: 50;
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 0.25rem;
            max-height: 12rem;
            overflow-y: auto;
        }

        .autocomplete-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.15s;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #f9fafb;
        }

        .autocomplete-item img {
            width: 1.5rem;
            height: 1.5rem;
            object-fit: contain;
            border-radius: 0.25rem;
        }

        .autocomplete-name {
            flex: 1;
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
        }

        .autocomplete-item small {
            color: #9ca3af;
            margin-left: auto;
        }

        .data-item:hover .item-actions {
            opacity: 1;
        }

        /* Util helpers */
        .hidden {
            display: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .border-top {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .w-full {
            width: 100%;
        }

        /* Icons */
        svg.icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        svg.icon-sm {
            width: 1rem;
            height: 1rem;
            min-width: 1rem;
            /* Prevent squeezing */
        }

        svg.chevron {
            color: var(--gray-color);
            transition: transform 0.2s;
        }

        /* Quadrant labels styling */
        .quadrant-label {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            fill: #a3a3a3;
            font-size: 14px;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <nav class="nav" role="navigation">
        <div class="nav__list">
            <a href="index.html" class="nav__item" aria-label="Homepage">Home</a>
            <a href="blog.html" class="nav__item" aria-label="Blog section">Blog</a>
            <a href="now.html" class="nav__item" aria-label="Now page">Now</a>
        </div>
        <div class="nav__list">
            <a href="http://linkedin.com/in/justinrichardhill/" class="nav__item" target="_blank">LinkedIn</a>
            <a href="#" class="nav__item js-email-link">Email</a>
        </div>
    </nav>

    <main class="container">
        <article>
            <header class="header-center">
                <h1>Market Heatmap</h1>
                <p>Compare companies by their execution and market strength.</p>
            </header>

            <figure class="mid-size heatmap-figure">

                <!-- Chart Column -->
                <div class="card chart-wrapper">
                    <div class="export-btn-container">
                        <button onclick="exportChartImage()" class="btn btn-white btn-icon-only" title="Export as PNG"
                            aria-label="Export Chart Image">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                    <div id="chart" class="chart-container">
                        Loading chart...
                    </div>
                </div>

                <!-- Chart Options Panel -->
                <div class="card">
                    <button class="form-header" onclick="toggleOptions()" aria-expanded="false"
                        aria-controls="options-content" id="options-toggle">
                        <h2>Chart Options</h2>
                        <svg id="options-chevron" xmlns="http://www.w3.org/2000/svg" class="icon chevron" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>

                    <div id="options-content" class="form-content" role="region" aria-labelledby="options-toggle">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="opt-xaxis">X-Axis Label</label>
                                <input type="text" id="opt-xaxis" value="MARKET STRENGTH">
                            </div>
                            <div class="form-group">
                                <label for="opt-yaxis">Y-Axis Label</label>
                                <input type="text" id="opt-yaxis" value="EXECUTION STRENGTH">
                            </div>
                        </div>

                        <div class="border-top">
                            <label class="mb-2">Axis Scaling</label>
                            <div class="form-grid-3 mb-2">
                                <div style="grid-column: span 3; font-size: 0.75rem; color: #9ca3af; font-weight: 500;">
                                    X-Axis (Market)</div>
                                <div>
                                    <label for="opt-xmin" class="sr-only">X-Axis Minimum</label>
                                    <input type="number" id="opt-xmin" value="6" step="0.5" placeholder="Min">
                                </div>
                                <div>
                                    <label for="opt-xmax" class="sr-only">X-Axis Maximum</label>
                                    <input type="number" id="opt-xmax" value="10" step="0.5" placeholder="Max">
                                </div>
                                <div>
                                    <label for="opt-xcross" class="sr-only">X-Axis Crosshair</label>
                                    <input type="number" id="opt-xcross" value="8" step="0.5" placeholder="Crosshair">
                                </div>
                            </div>
                            <div class="form-grid-3">
                                <div style="grid-column: span 3; font-size: 0.75rem; color: #9ca3af; font-weight: 500;">
                                    Y-Axis (Execution)</div>
                                <div>
                                    <label for="opt-ymin" class="sr-only">Y-Axis Minimum</label>
                                    <input type="number" id="opt-ymin" value="7" step="0.5" placeholder="Min">
                                </div>
                                <div>
                                    <label for="opt-ymax" class="sr-only">Y-Axis Maximum</label>
                                    <input type="number" id="opt-ymax" value="10" step="0.5" placeholder="Max">
                                </div>
                                <div>
                                    <label for="opt-ycross" class="sr-only">Y-Axis Crosshair</label>
                                    <input type="number" id="opt-ycross" value="8.5" step="0.5" placeholder="Crosshair">
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="opt-bg">
                                <label for="opt-bg"
                                    style="margin:0; text-transform:none; font-weight:400; font-size: 0.875rem; color:#374151;">Show
                                    Background Logo</label>
                            </div>
                            <input type="text" id="opt-bg-url" placeholder="https://example.com/logo.png"
                                class="hidden mt-4"
                                value="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Brown_Brothers_Harriman_Logo_1.svg/1200px-Brown_Brothers_Harriman_Logo_1.svg.png">
                        </div>

                        <div class="border-top">
                            <h3 class="mb-2"
                                style="font-size:0.75rem; color:var(--gray-color); text-transform:uppercase; letter-spacing:0.025em; font-family:var(--font-ui)">
                                Quadrant Labels</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="opt-q2" class="mb-1" style="color: #9ca3af; text-transform:none;">Top
                                        Left (High Y, Low X)</label>
                                    <input type="text" id="opt-q2" value="HIGHFLIER">
                                </div>
                                <div class="form-group">
                                    <label for="opt-q1" class="mb-1" style="color: #9ca3af; text-transform:none;">Top
                                        Right (High Y, High X)</label>
                                    <input type="text" id="opt-q1" value="LEADER">
                                </div>
                                <div class="form-group">
                                    <label for="opt-q3" class="mb-1" style="color: #9ca3af; text-transform:none;">Bottom
                                        Left (Low Y, Low X)</label>
                                    <input type="text" id="opt-q3" value="CHALLENGER">
                                </div>
                                <div class="form-group">
                                    <label for="opt-q4" class="mb-1" style="color: #9ca3af; text-transform:none;">Bottom
                                        Right (Low Y, High X)</label>
                                    <input type="text" id="opt-q4" value="OUTPERFORMER">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table Column -->
                    <div class="card w-full">
                        <div class="data-header">
                            <h2>Company Data</h2>
                            <div class="data-actions">
                                <input type="file" id="csv-input" accept=".csv" class="hidden">
                                <button onclick="document.getElementById('csv-input').click()" class="btn btn-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    Import CSV
                                </button>
                                <button onclick="exportTableToCSV()" class="btn btn-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Export CSV
                                </button>
                            </div>
                        </div>

                        <div class="data-list" id="company-list">
                            <!-- Items will be injected here -->
                        </div>

                        <!-- Add New Row Form -->
                        <div class="border-top">
                            <h3 class="mb-3"
                                style="font-size:0.875rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">
                                Add New Company
                            </h3>
                            <form id="add-company-form">
                                <div class="form-group relative">
                                    <input type="text" id="input-name" placeholder="Company Name" required
                                        autocomplete="off">
                                    <div id="autocomplete-list" class="autocomplete-dropdown hidden">
                                        <!-- Dropdown items -->
                                    </div>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="input-logo" placeholder="Company Domain (e.g. circle.com)"
                                        aria-label="Company Domain">
                                </div>
                                <div class="form-row mb-3">
                                    <div>
                                        <label for="input-market">Market Strength (0-10)</label>
                                        <input type="number" id="input-market" placeholder="8.5" step="0.1" min="0"
                                            max="10" required>
                                    </div>
                                    <div>
                                        <label for="input-execution">Execution Strength (0-10)</label>
                                        <input type="number" id="input-execution" placeholder="8.5" step="0.1" min="0"
                                            max="10" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Company
                                </button>
                            </form>
                        </div>
                    </div>
            </figure>
            <p>This visualization is a 2x2 matrix, a standard tool used in business analysis to
                compare companies. It moves beyond simple rankings to provide a more nuanced view of the competitive
                landscape. The Gartner Magic Quadrant is a well-known example of this type of visualization.</p>

            <p>A linear top-10 list often obscures important details. A large company might be ranked highly simply
                because it is big, even if it is growing slowly or has outdated technology. Conversely, a small company
                might be innovative and fast-moving, but lack the visibility to appear on a top-ten list.</p>
            <p>By using two axes, this chart separates a company’s size from its performance:</p>
            <ul>
                <li><strong>The X-Axis (Market Strength):</strong> This measures a company&#39;s dominance. It
                    typically includes factors like market share, brand recognition, and available capital.</li>
                <li><strong>The Y-Axis (Execution Strength):</strong> This measures a company&#39;s operational
                    capability.
                    It looks at how well a company delivers its product, the speed of its updates, and the quality
                    of its technology.</li>
            </ul>
            <h3 id="the-four-quadrants">The Four Quadrants</h3>
            <p>The intersecting axes create four categories that help to identify different types of business
                opportunities:</p>
            <ul>
                <li><strong>Leaders (Top Right):</strong> These companies combine a large market presence with
                    strong
                    operational performance. In this analysis, <strong>Coinbase</strong> and <strong>Ripple</strong>
                    appear
                    here, indicating they are both widely used and effectively managed.</li>
                <li><strong>Highfliers (Top Left):</strong> These are companies with excellent products and
                    execution,
                    but
                    they have not yet achieved mass market adoption. They are often viewed as promising challengers
                    with
                    high growth potential.</li>
                <li><strong>Outperformers (Bottom Right):</strong> These firms have significant market share but
                    score
                    lower
                    on execution. They are often established players that may be relying on their brand name rather
                    than
                    innovation.</li>
                <li><strong>Challengers (Bottom Left):</strong> These companies are currently lagging in both market
                    share
                    and execution. They face the most significant hurdles to growth.</li>
            </ul>
            <p>The value of this visualization lies in its ability to show potential. While a standard graph shows
                who
                is
                winning today, a 2x2 matrix offers a view of who might win tomorrow. It highlights which small
                companies
                are
                executing well enough to become future leaders, and which large companies may be vulnerable due to
                poor
                performance.</p>
        </article>
    </main>

    <script>
        // Chart Config State
        const chartConfig = {
            xAxisLabel: "MARKET STRENGTH",
            yAxisLabel: "EXECUTION STRENGTH",
            q1Label: "LEADER",    // Top Right
            q2Label: "HIGHFLIER", // Top Left
            q3Label: "CHALLENGER",// Bottom Left
            q4Label: "OUTPERFORMER", // Bottom Right
            showBackground: false,
            bgUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Brown_Brothers_Harriman_Logo_1.svg/1200px-Brown_Brothers_Harriman_Logo_1.svg.png",
            // Scaling Defaults
            xMin: 6, xMax: 10, xCrosshair: 8,
            yMin: 7, yMax: 10, yCrosshair: 8.5
        };

        // Initial Data
        let companies = [
            { name: "Circle", domain: "circle.com", market: 9.6, execution: 9.7 },
            { name: "Coinbase", domain: "coinbase.com", market: 9.6, execution: 9.7 },
            { name: "Ripple", domain: "ripple.com", market: 9.7, execution: 9.3 },
            { name: "BitGo", domain: "bitgo.com", market: 9.6, execution: 8.8 },
            { name: "Stellar", domain: "stellar.org", market: 8.4, execution: 8.8 },
            { name: "Bridge", domain: "bridge.xyz", market: 7.9, execution: 8.7 },
            { name: "Aptos Labs", domain: "aptoslabs.com", market: 6.9, execution: 8.7 },
            { name: "Stable", domain: "stable.com", market: 7.2, execution: 8.2 },
            { name: "Bastion", domain: "bastion.com", market: 8.0, execution: 8.2 },
            { name: "Cyclops", domain: "cyclops.xyz", market: 7.8, execution: 7.9 },
            { name: "Omnia Systems", domain: "omniasystems.com", market: 7.9, execution: 7.7 },
            { name: "Zero Hash", domain: "zerohash.com", market: 8.5, execution: 8.6 },
            { name: "Fireblocks", domain: "fireblocks.com", market: 7.5, execution: 8.8 },
            { name: "Paxos", domain: "paxos.com", market: 8.6, execution: 7.9 },
            { name: "1Money", domain: "1money.com", market: 7.4, execution: 8.0 },
            { name: "Anchorage Digital", domain: "anchorage.com", market: 7.3, execution: 7.9 }
        ];

        const chartContainer = document.getElementById('chart');
        const companyList = document.getElementById('company-list');
        const addForm = document.getElementById('add-company-form');
        const titleForm = document.querySelector('#add-company-form').previousElementSibling; // The H3 header
        const btnSubmit = addForm.querySelector('button[type="submit"]');
        const inputName = document.getElementById('input-name');
        const inputLogo = document.getElementById('input-logo');
        const optBg = document.getElementById('opt-bg');
        const optBgUrl = document.getElementById('opt-bg-url');

        // Toggle Background Input Visibility and State
        optBg.addEventListener('change', (e) => {
            chartConfig.showBackground = e.target.checked;
            optBgUrl.style.display = e.target.checked ? 'block' : 'none'; // Toggle input
            renderChart();
        });

        optBgUrl.addEventListener('input', (e) => {
            chartConfig.bgUrl = e.target.value;
            renderChart();
        });

        let editingIndex = null; // Track if we are editing

        // Helper: Manual Overrides
        const customOverrides = {
            'bbh.com': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Brown_Brothers_Harriman_Logo_1.svg/1200px-Brown_Brothers_Harriman_Logo_1.svg.png',
            'brownbrothersharriman.com': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Brown_Brothers_Harriman_Logo_1.svg/1200px-Brown_Brothers_Harriman_Logo_1.svg.png'
        };

        // Helper: Get Logo URL Waterfall
        const getBrandfetchUrl = (domain) => `https://corsproxy.io/?url=${encodeURIComponent(`https://asset.brandfetch.io/${domain}?types=icon&formats=png,svg`)}`;
        const getGoogleUrl = (domain) => `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
        const getInitialsUrl = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&rounded=true&bold=true`;

        // Helper: Logo Error Handler / Waterfall
        window.handleLogoError = function (img, domain, name) {
            const currentStep = img.dataset.step;

            // Waterfall Sequence:
            // 1. provided_logo (from API) -> Fail
            // 2. brandfetch -> Fail
            // 3. clearbit_logo -> Fail
            // 4. google -> Fail
            // 5. Company initials

            if (currentStep === 'provided_logo') {
                if (domain) {
                    img.src = getBrandfetchUrl(domain);
                    img.dataset.step = 'brandfetch';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'brandfetch') {
                if (domain) {
                    // Use Corsproxy for Clearbit too
                    img.src = `https://corsproxy.io/?url=${encodeURIComponent(`https://logo.clearbit.com/${domain}`)}`;
                    img.dataset.step = 'clearbit_logo';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'clearbit_logo') {
                if (domain) {
                    img.src = getGoogleUrl(domain);
                    img.dataset.step = 'google';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'google') {
                // Final hail mary: DuckDuckGo
                if (domain) {
                    img.src = `https://icons.duckduckgo.com/ip3/${domain}.ico`;
                    img.dataset.step = 'ddg';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'ddg') {
                img.src = getInitialsUrl(name);
                img.dataset.step = 'initials';
            }
        };

        // Success Handler: Syncs working URL back to data and redraws chart if needed
        let chartUpdateTimer;
        window.handleLogoSuccess = function (img, name) {
            const company = companies.find(c => c.name === name);
            if (company && company.logo !== img.src) {
                // Only update and re-render if the logo effectively changed
                // (e.g. from null to a resolved URL, or from one URL to a working fallback)
                company.logo = img.src;

                // Debounce chart update to avoid thrashing on initial load
                clearTimeout(chartUpdateTimer);
                chartUpdateTimer = setTimeout(() => {
                    renderChart();
                }, 500);
            }
        };

        // Render Table
        function renderTable() {
            companyList.innerHTML = '';
            companies.forEach((company, index) => {
                const row = document.createElement('div');
                row.className = 'data-item group';

                // Initial Logo Source determination
                let startSrc = company.logo;
                let startStep = 'provided_logo';

                // Check overrides first
                if (company.domain && customOverrides[company.domain.toLowerCase()]) {
                    startSrc = customOverrides[company.domain.toLowerCase()];
                    startStep = 'override'; // Special step that shouldn't error often, but if it does, handleLogoError will default to initials
                } else if (!startSrc) {
                    if (company.domain) {
                        startSrc = getBrandfetchUrl(company.domain);
                        startStep = 'brandfetch';
                    } else {
                        startSrc = getInitialsUrl(company.name);
                        startStep = 'initials';
                    }
                }

                row.innerHTML = `
          <div class="data-item-info">
            <div class="company-avatar">
              <img src="${startSrc}" 
                   alt="${company.name}" 
                   data-step="${startStep}"
                   onload="handleLogoSuccess(this, '${company.name}')"
                   onerror="handleLogoError(this, '${company.domain || ''}', '${company.name}')">
            </div>
            <div class="company-details">
              <p class="name">${company.name}</p>
              <p class="stats">M: ${company.market} | E: ${company.execution}</p>
            </div>
          </div>
          <div class="item-actions">
            <button onclick="editCompany(${index})" class="btn btn-ghost btn-icon-only" title="Edit" aria-label="Edit ${company.name}">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
            <button onclick="deleteCompany(${index})" class="btn btn-ghost btn-icon-only delete-btn" title="Remove" aria-label="Delete ${company.name}">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
          </div>
        `;
                companyList.appendChild(row);
            });
        }


        // Render Chart
        function renderChart() {
            chartContainer.innerHTML = '';

            const xCenter = (chartConfig.xMin + chartConfig.xMax) / 2;
            const yCenter = (chartConfig.yMin + chartConfig.yMax) / 2;

            const plot = Plot.plot({
                width: chartContainer.clientWidth,
                height: 600,
                marginTop: 40,
                marginRight: 40,
                marginBottom: 60,
                marginLeft: 80,
                ariaLabel: "Market Strength vs Execution Strength Heatmap",
                ariaDescription: "A quadrant chart comparing companies based on their Market Strength (X-axis) and Execution Strength (Y-axis).",
                // ... (rest of config)
                x: {
                    domain: [chartConfig.xMin, chartConfig.xMax],
                    axis: null // Hide default axis
                },
                y: {
                    domain: [chartConfig.yMin, chartConfig.yMax],
                    axis: null // Hide default axis
                },
                style: {
                    background: "transparent",
                    fontSize: "14px",
                    fontFamily: "Inter, sans-serif",
                    overflow: "visible"
                },
                marks: [
                    // Dynamic Background Image
                    chartConfig.showBackground && chartConfig.bgUrl ? Plot.image([{ x: xCenter, y: yCenter }], {
                        x: "x",
                        y: "y",
                        src: chartConfig.bgUrl,
                        width: 400, // Fixed width or maybe relative to container?
                        opacity: 0.1,
                        title: "Background Logo"
                    }) : null,

                    Plot.rect([{ x: 0 }], {
                        x1: chartConfig.xMin, x2: chartConfig.xMax,
                        y1: chartConfig.yMin, y2: chartConfig.yMax,
                        rx: 20,
                        stroke: "#9ca3af",
                        strokeWidth: 3,
                        fill: "none"
                    }),

                    Plot.ruleX([chartConfig.xCrosshair], { stroke: "#9ca3af", strokeWidth: 2, y1: chartConfig.yMin, y2: chartConfig.yMax }),
                    Plot.ruleY([chartConfig.yCrosshair], { stroke: "#9ca3af", strokeWidth: 2, x1: chartConfig.xMin, x2: chartConfig.xMax }),

                    Plot.text([{ label: chartConfig.xAxisLabel + " →" }], {
                        x: chartConfig.xCrosshair,
                        y: chartConfig.yMin - (chartConfig.yMax - chartConfig.yMin) * 0.08,
                        text: "label",
                        fill: "#9ca3af",
                        fontSize: 14,
                        fontWeight: "bold"
                    }),
                    Plot.text([{ label: chartConfig.yAxisLabel + " →" }], {
                        x: chartConfig.xMin - (chartConfig.xMax - chartConfig.xMin) * 0.08,
                        y: chartConfig.yCrosshair,
                        text: "label",
                        fill: "#9ca3af",
                        fontSize: 14,
                        fontWeight: "bold",
                        rotate: -90
                    }),

                    Plot.text([{ x: chartConfig.xMin + 0.2, y: chartConfig.yMax - 0.2, label: chartConfig.q2Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "start", pointerEvents: "none" }),
                    Plot.text([{ x: chartConfig.xMax - 0.2, y: chartConfig.yMax - 0.2, label: chartConfig.q1Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "end", pointerEvents: "none" }),
                    Plot.text([{ x: chartConfig.xMin + 0.2, y: chartConfig.yMin + 0.2, label: chartConfig.q3Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "start", pointerEvents: "none" }),
                    Plot.text([{ x: chartConfig.xMax - 0.2, y: chartConfig.yMin + 0.2, label: chartConfig.q4Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "end", pointerEvents: "none" }),

                    // 5. Images (Google Favicons -> now robust)
                    Plot.image(companies, {
                        x: "market",
                        y: "execution",
                        src: d => d.logo || getGoogleUrl(d.domain),
                        width: 32,
                        height: 32,
                        title: "name"
                    }),

                    // 6. Tooltips
                    Plot.tip(companies, Plot.pointer({
                        x: "market",
                        y: "execution",
                        title: d => `${d.name}\nMarket Strength: ${d.market}\nExecution Strength: ${d.execution}`,
                        fill: "white",
                        stroke: "#e5e7eb",
                        ariaLabel: "Tooltip",
                        textPadding: 10, // Add some padding
                        opacity: 1, // Ensure opaque
                        style: {
                            color: "#1f2937", // Dark gray text
                            fontSize: "14px",
                            lineHeight: "1.2",
                            boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1)"
                        }
                    }))
                ]
            });

            chartContainer.appendChild(plot);
        }

        // Add / Update Company Logic
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('input-name').value;
            const domainInput = document.getElementById('input-logo').value; // This is the domain
            const market = parseFloat(document.getElementById('input-market').value);
            const execution = parseFloat(document.getElementById('input-execution').value);

            let logoUrl = null;

            // Auto-discover logo if domain/name present
            if (name) {
                const btnOriginal = btnSubmit.innerHTML;
                btnSubmit.textContent = "Verifying...";
                btnSubmit.disabled = true;

                try {
                    const data = await fetchCompanyData(name);
                    if (data && data.length > 0) {
                        logoUrl = data[0].logo;
                    }
                } catch (err) {
                    console.log("Auto-discovery failed", err);
                }

                // If API didn't give a logo, we rely on domain-based fallbacks in the renderer.
                // We don't need to force Initials here unless we want to lock it in.
                // Better to leave logoUrl null if not found, so renderer waterfall works.

                addOrUpdateCompany(name, domainInput, logoUrl, market, execution);
                resetFormState(btnOriginal);
            }
        });

        function addOrUpdateCompany(name, domain, logo, market, execution) {
            // Auto-scale logic
            let updated = false;
            if (market > chartConfig.xMax) { chartConfig.xMax = Math.ceil(market * 2) / 2; updated = true; }
            if (market < chartConfig.xMin) { chartConfig.xMin = Math.floor(market * 2) / 2; updated = true; }
            if (execution > chartConfig.yMax) { chartConfig.yMax = Math.ceil(execution * 2) / 2; updated = true; }
            if (execution < chartConfig.yMin) { chartConfig.yMin = Math.floor(execution * 2) / 2; updated = true; }

            if (updated) {
                // Sync UI inputs
                document.getElementById('opt-xmax').value = chartConfig.xMax;
                document.getElementById('opt-xmin').value = chartConfig.xMin;
                document.getElementById('opt-ymax').value = chartConfig.yMax;
                document.getElementById('opt-ymin').value = chartConfig.yMin;
            }

            if (editingIndex !== null) {
                // Update existing
                companies[editingIndex] = { name, domain, logo, market, execution };
                editingIndex = null;
                titleForm.textContent = "ADD NEW COMPANY";
            } else {
                // Add new
                companies.push({ name, domain, logo, market, execution });
            }
            renderTable();
            renderChart();
            addForm.reset();
        }

        function resetFormState(originalContent) {
            btnSubmit.innerHTML = originalContent || `
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg> Add Company`;
            btnSubmit.disabled = false;

            // Re-apply correct styles based on mode (Add vs Edit reset)
            if (editingIndex === null) {
                btnSubmit.classList.remove('btn-success');
                btnSubmit.classList.add('btn-primary');
            }
        }

        // Edit Company Logic
        window.editCompany = (index) => {
            const company = companies[index];
            document.getElementById('input-name').value = company.name;
            document.getElementById('input-logo').value = company.logo;
            document.getElementById('input-market').value = company.market;
            document.getElementById('input-execution').value = company.execution;

            editingIndex = index;
            titleForm.textContent = "EDIT COMPANY";
            btnSubmit.textContent = "Update Company";
            btnSubmit.classList.remove('btn-primary');
            btnSubmit.classList.add('btn-success');
        };

        // Delete Company Logic
        window.deleteCompany = (index) => {
            if (confirm('Are you sure you want to delete this company?')) {
                companies.splice(index, 1);
                // If we were editing this item, cancel edit
                if (editingIndex === index) {
                    addForm.reset();
                    editingIndex = null;
                    titleForm.textContent = "ADD NEW COMPANY";
                    btnSubmit.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Add Company`;
                    btnSubmit.classList.remove('btn-success');
                    btnSubmit.classList.add('btn-primary');
                }
                renderTable();
                renderChart();
            }
        };

        // Logo Autocomplete (Clearbit) - Dropdown Style
        let typingTimer;
        const autocompleteList = document.getElementById('autocomplete-list');

        // Helper: Robust Company Fetch (with Proxy Fallback)
        async function fetchCompanyData(query) {
            const endpoint = `https://autocomplete.clearbit.com/v1/companies/suggest?query=${encodeURIComponent(query)}`;
            // "corsproxy.io" often handles these requests better than allorigins
            const proxyEndpoint = `https://corsproxy.io/?url=${encodeURIComponent(endpoint)}`;

            try {
                // Try direct first
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (err) {
                // console.warn('Direct fetch blocked (CORS/Adblock), trying proxy...');
                try {
                    const response = await fetch(proxyEndpoint);
                    if (!response.ok) throw new Error('Proxy network response was not ok');
                    return await response.json();
                } catch (proxyErr) {
                    console.warn('Logo autocomplete unavailable (likely network blocked). Manual entry required.');
                    return [];
                }
            }
        }

        inputName.addEventListener('input', () => {
            clearTimeout(typingTimer);
            const query = inputName.value;

            if (query.length < 2) {
                autocompleteList.classList.add('hidden');
                return;
            }

            typingTimer = setTimeout(async () => {
                const data = await fetchCompanyData(query);

                autocompleteList.innerHTML = '';

                if (data && data.length > 0) {
                    autocompleteList.classList.remove('hidden');
                    data.forEach(company => {
                        const item = document.createElement('div');

                        // Use Initials as immediate placeholder
                        const initialsUrl = getInitialsUrl(company.name);

                        item.className = 'autocomplete-item';
                        item.innerHTML = `
                            <div class="company-avatar" style="width:1.5rem; height:1.5rem; min-width:1.5rem; border-radius: 0.25rem;">
                                <img src="${initialsUrl}" 
                                   class="w-full h-full object-contain" 
                                   id="logo-${company.domain || company.name.replace(/\s/g, '')}"
                                   alt="${company.name}">
                            </div>
                            <div class="autocomplete-name">${company.name}</div>
                        `;

                        // Silently hunt for a better logo in background
                        findBestLogoUrl(company.domain, company.logo).then(betterLogo => {
                            if (betterLogo) {
                                const img = item.querySelector('img');
                                if (img) img.src = betterLogo;
                            }
                        });

                        item.addEventListener('click', () => {
                            inputName.value = company.name;
                            inputLogo.value = company.domain;
                            autocompleteList.classList.add('hidden');
                        });
                        autocompleteList.appendChild(item);
                    });
                } else {
                    autocompleteList.classList.add('hidden');
                }
            }, 300); // 300ms debounce
        });

        // Helper: Silently check if a logo exists (Prevent Console 404s)
        async function findBestLogoUrl(domain, providedUrl) {


            if (domain && customOverrides[domain.toLowerCase()]) {
                return customOverrides[domain.toLowerCase()];
            }

            // Helper to check a single URL via Image object
            const check = (targetUrl) => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(targetUrl);
                    img.onerror = () => resolve(null);
                    img.src = targetUrl;
                });
            };

            // 1. Try provided URL (from Clearbit API) via Proxy
            // Using corsproxy.io as Weserv is being blocked by upstream providers
            if (providedUrl) {
                const safeProvided = providedUrl.startsWith('http') ? providedUrl : `https://${providedUrl}`;
                const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(safeProvided)}`;
                if (await check(proxyUrl)) return proxyUrl;
            }

            if (!domain) return null;

            // 2. Try Brandfetch via Proxy
            // Brandfetch often has high quality vector-like PNGs
            const brandfetchUrl = `https://asset.brandfetch.io/${domain}?types=icon&formats=png,svg`;
            const bfProxy = `https://corsproxy.io/?url=${encodeURIComponent(brandfetchUrl)}`;
            if (await check(bfProxy)) return bfProxy;

            // 3. Try Clearbit via Proxy
            const clearbitUrl = `https://logo.clearbit.com/${domain}`;
            const cbProxy = `https://corsproxy.io/?url=${encodeURIComponent(clearbitUrl)}`;
            if (await check(cbProxy)) return cbProxy;

            // 4. Fallback: Google Favicons (Very reliable, rarely blocked, good for small icons)
            // Requesting large size (128) to get best available quality
            const googleUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            // Google usually returns a default globe icon on failure, so we accept it as better than nothing,
            // or we could check its dimensions. For now, let's try it as a last resort.
            if (await check(googleUrl)) return googleUrl;

            // 5. Fallback: DuckDuckGo Icons (Alternative coverage)
            const ddgUrl = `https://icons.duckduckgo.com/ip3/${domain}.ico`;
            if (await check(ddgUrl)) return ddgUrl;

            return null;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!inputName.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.classList.add('hidden');
            }
        });

        // Responsive Redraw
        window.addEventListener('resize', () => {
            renderChart();
        });

        // Export Chart Logic
        window.exportChartImage = async () => {
            const originalNode = document.getElementById('chart');
            if (!originalNode) return;

            // Helper: Fetch image via proxy and convert to Base64
            const toBase64 = async (url) => {
                if (!url || url.startsWith('data:')) return url;

                const needsProxy = /google\.com|clearbit\.com/.test(url);
                const attempts = [];

                if (!needsProxy) attempts.push({ url, name: 'Direct' });
                // Proxies
                const noProto = url.replace(/^https?:\/\//, '');
                attempts.push({ url: `https://images.weserv.nl/?url=${encodeURIComponent(noProto)}&output=png`, name: 'Weserv' });
                attempts.push({ url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, name: 'AllOrigins' });

                for (const attempt of attempts) {
                    try {
                        const response = await fetch(attempt.url);
                        if (!response.ok) throw new Error('Response not ok');
                        const blob = await response.blob();
                        return await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                    } catch (e) { /* continue */ }
                }
                return null;
            };

            try {
                const rect = originalNode.getBoundingClientRect();
                const clonedNode = originalNode.cloneNode(true);

                // Invisible Overlay Strategy
                Object.assign(clonedNode.style, {
                    width: `${rect.width}px`,
                    height: `${rect.height}px`,
                    position: 'fixed',
                    left: '0',
                    top: '0',
                    zIndex: '-9999',
                    opacity: '0', // Completely hidden from user
                    margin: '0',
                    pointerEvents: 'none'
                });

                document.body.appendChild(clonedNode);

                // Convert images to Base64
                const images = clonedNode.querySelectorAll('image, img');
                const diffs = Array.from(images).map(async (img) => {
                    let src = img.tagName === 'image' ? (img.getAttribute('href') || img.getAttribute('xlink:href')) : img.getAttribute('src');
                    if (src && (src.startsWith('http') || src.startsWith('//'))) {
                        const base64 = await toBase64(src);
                        if (base64) {
                            if (img.tagName === 'image') {
                                img.setAttribute('href', base64);
                                if (img.hasAttribute('xlink:href')) img.setAttribute('xlink:href', base64);
                            } else {
                                img.setAttribute('src', base64);
                            }
                        }
                    }
                });

                await Promise.all(diffs);
                await new Promise(resolve => setTimeout(resolve, 100)); // Paint delay

                const dataUrl = await htmlToImage.toPng(clonedNode, {
                    backgroundColor: '#ffffff',
                    pixelRatio: 2,
                    skipFonts: true,
                    filter: (node) => node.tagName !== 'BUTTON',
                    style: { opacity: '1' } // Force visible capture
                });

                document.body.removeChild(clonedNode);

                const link = document.createElement('a');
                link.download = `market-heatmap-${new Date().toISOString().slice(0, 10)}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export chart image.');
            }
        };



        // CSV Export Logic
        window.exportTableToCSV = () => {
            const headers = ['name', 'domain', 'market', 'execution'];
            const csvRows = [headers.join(',')];

            companies.forEach(company => {
                const row = [
                    `"${company.name.replace(/"/g, '""')}"`, // Handle quotes in name
                    `"${(company.domain || '').replace(/"/g, '""')}"`,
                    company.market,
                    company.execution
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "companies.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // CSV Import Logic
        const csvInput = document.getElementById('csv-input');
        csvInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.name.split('.').pop().toLowerCase() !== 'csv') {
                alert('Please upload a valid CSV file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const text = event.target.result;
                parseCSV(text);
                csvInput.value = ''; // Reset input
            };
            reader.readAsText(file);
        });

        function parseCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) {
                alert('CSV file appears to be empty or missing data.');
                return;
            }

            // Simple CSV parser assuming "header1,header2" format
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));

            const nameIdx = headers.indexOf('name');
            const domainIdx = headers.indexOf('domain');
            const marketIdx = headers.indexOf('market');
            const execIdx = headers.indexOf('execution');

            if (nameIdx === -1 || marketIdx === -1 || execIdx === -1) {
                alert('CSV must contain "name", "market", and "execution" columns.');
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;

            for (let i = 1; i < lines.length; i++) {
                // Regex for splitting by comma but ignoring commas within quotes
                const rowMatch = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                // Fallback splitting if match fails
                const cols = rowMatch ? rowMatch.map(c => c.trim().replace(/^"|"$/g, '')) : lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));

                if (cols.length < headers.length) continue;

                const name = cols[nameIdx];
                const domain = domainIdx !== -1 ? cols[domainIdx] : '';
                const market = parseFloat(cols[marketIdx]);
                const execution = parseFloat(cols[execIdx]);

                if (name && !isNaN(market) && !isNaN(execution)) {
                    // Check for duplicates
                    const exists = companies.some(c => c.name.toLowerCase() === name.toLowerCase());
                    if (exists) {
                        skippedCount++;
                        continue;
                    }

                    companies.push({
                        name,
                        domain,
                        market,
                        execution,
                        // Set logo to null to trigger renderTable auto-discovery (Overrides -> Proxy -> Fallback)
                        logo: null
                    });
                    addedCount++;
                }
            }

            if (addedCount > 0) {
                renderTable();
                renderChart();
                alert(`Successfully imported ${addedCount} companies.${skippedCount > 0 ? ` Skipped ${skippedCount} duplicates.` : ''}`);
            } else if (skippedCount > 0) {
                alert(`No new companies imported. Skipped ${skippedCount} duplicates.`);
            } else {
                alert('No valid companies found to import.');
            }
        }

        // Options Logic
        function toggleOptions() {
            const content = document.getElementById('options-content');
            const chevron = document.getElementById('options-chevron');
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // Bind Options Inputs
        ['opt-xaxis', 'opt-yaxis', 'opt-q1', 'opt-q2', 'opt-q3', 'opt-q4'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = e.target.value;
                if (id === 'opt-xaxis') chartConfig.xAxisLabel = val;
                if (id === 'opt-yaxis') chartConfig.yAxisLabel = val;
                if (id === 'opt-q1') chartConfig.q1Label = val;
                if (id === 'opt-q2') chartConfig.q2Label = val;
                if (id === 'opt-q3') chartConfig.q3Label = val;
                if (id === 'opt-q4') chartConfig.q4Label = val;
                renderChart();
            });
        });

        // Scaling Inputs
        ['opt-xmin', 'opt-xmax', 'opt-xcross', 'opt-ymin', 'opt-ymax', 'opt-ycross'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                if (isNaN(val)) return;

                if (id === 'opt-xmin') chartConfig.xMin = val;
                if (id === 'opt-xmax') chartConfig.xMax = val;
                if (id === 'opt-xcross') chartConfig.xCrosshair = val;

                if (id === 'opt-ymin') chartConfig.yMin = val;
                if (id === 'opt-ymax') chartConfig.yMax = val;
                if (id === 'opt-ycross') chartConfig.yCrosshair = val;

                renderChart();
            });
        });

        // Background Toggle
        document.getElementById('opt-bg').addEventListener('change', (e) => {
            chartConfig.showBackground = e.target.checked;
            renderChart();
        });

        // Init
        renderTable();
        renderChart();

    </script>

</body>

</html>