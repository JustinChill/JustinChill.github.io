<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
    <title>Market Heatmap | Justin Chill</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Create your own interactive market heatmap. Compare companies on market and execution strength, export high-quality quadrant charts, and customize your analysis.">
    <meta name="author" content="Justin Chill">

    <!-- OpenGraph tags -->
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="JustinChill">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Market Heatmap | Justin Chill">
    <meta property="og:description"
        content="Create your own interactive market heatmap. Compare companies on market and execution strength, export high-quality quadrant charts, and customize your analysis.">
    <meta property="og:url" content="https://justinchill.com/heatmap.html">
    <meta property="og:image" content="https://justinchill.com/imgs/heatmap_cover.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@JustinChill">
    <meta name="twitter:creator" content="@JustinChill">
    <meta name="twitter:title" content="Market Heatmap | Justin Chill">
    <meta name="twitter:description"
        content="Create your own interactive market heatmap. Compare companies on market and execution strength, export high-quality quadrant charts, and customize your analysis.">

    <link rel="icon" href="/favicon.ico">
    <meta name="theme-color" content="#4C63B6">

    <!-- styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">


    <script type="module">
        document.documentElement.classList.remove('no-js');
        document.documentElement.classList.add('js');
    </script>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

    <style>
        /* Glassmorphism & Custom Styles */
        body {
            background: #fdfdfd;
            /* Optional: subtle gradient background for better glass effect */
            background: linear-gradient(135deg, #fdfdfd 0%, #f3f4f6 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 1rem;
        }

        .chart-container {
            width: 100%;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Quadrant labels styling */
        .quadrant-label {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            fill: #a3a3a3;
            font-size: 14px;
            pointer-events: none;
        }

        /* Input styling */
        input[type="text"],
        input[type="number"] {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>

<body>
    <nav class="nav" role="navigation">
        <div class="nav__list">
            <a href="index.html" class="nav__item" aria-label="Homepage">Home</a>
            <a href="blog.html" class="nav__item" aria-label="Blog section">Blog</a>
            <a href="now.html" class="nav__item" aria-label="Now page">Now</a>
        </div>
        <div class="nav__list">
            <a href="http://linkedin.com/in/justinrichardhill/" class="nav__item" target="_blank">LinkedIn</a>
            <a href="#" class="nav__item js-email-link">Email</a>
        </div>
    </nav>

    <main class="container mx-auto px-5 py-8">
        <header class="mb-10 text-center max-w-2xl mx-auto">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Market Heatmap</h1>
            <p class="text-gray-500">Compare companies by their execution and market strength.</p>
        </header>

        <div class="flex flex-col gap-8 max-w-4xl mx-auto">

            <!-- Chart Column -->
            <div class="glass-panel p-6 shadow-xl relative w-full">
                <div class="absolute top-6 right-6 z-10">
                    <button onclick="exportChartImage()"
                        class="bg-white/80 hover:bg-white text-gray-700 p-2 rounded-lg shadow-sm border border-gray-200 transition-all"
                        title="Export as PNG">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
                <div id="chart" class="chart-container text-gray-400 text-sm">
                    Loading chart...
                </div>
            </div>

            <!-- Chart Options Panel -->
            <div class="glass-panel p-6 shadow-xl w-full">
                <button class="flex items-center justify-between w-full text-left" onclick="toggleOptions()">
                    <h2 class="text-xl font-bold text-gray-800">Chart Options</h2>
                    <svg id="options-chevron" xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 text-gray-500 transform transition-transform" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <div id="options-content" class="hidden mt-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">X-Axis
                                Label</label>
                            <input type="text" id="opt-xaxis" value="MARKET STRENGTH" class="text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Y-Axis
                                Label</label>
                            <input type="text" id="opt-yaxis" value="EXECUTION STRENGTH" class="text-sm">
                        </div>
                    </div>

                    <div class="border-t border-gray-100 pt-3">
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Axis
                            Scaling</label>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <div class="col-span-3 text-xs text-gray-400 font-medium">X-Axis (Market)</div>
                            <div>
                                <input type="number" id="opt-xmin" value="6" step="0.5" class="text-sm"
                                    placeholder="Min">
                            </div>
                            <div>
                                <input type="number" id="opt-xmax" value="10" step="0.5" class="text-sm"
                                    placeholder="Max">
                            </div>
                            <div>
                                <input type="number" id="opt-xcross" value="8" step="0.5" class="text-sm"
                                    placeholder="Crosshair">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-3 text-xs text-gray-400 font-medium">Y-Axis (Execution)</div>
                            <div>
                                <input type="number" id="opt-ymin" value="7" step="0.5" class="text-sm"
                                    placeholder="Min">
                            </div>
                            <div>
                                <input type="number" id="opt-ymax" value="10" step="0.5" class="text-sm"
                                    placeholder="Max">
                            </div>
                            <div>
                                <input type="number" id="opt-ycross" value="8.5" step="0.5" class="text-sm"
                                    placeholder="Crosshair">
                            </div>
                        </div>
                    </div>

                    <div class="mt-2 space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="opt-bg"
                                class="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4">
                            <label for="opt-bg" class="text-sm text-gray-700">Show Background Logo</label>
                        </div>
                        <input type="text" id="opt-bg-url" placeholder="https://example.com/logo.png"
                            class="text-sm w-full hidden border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                            value="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Brown_Brothers_Harriman_Logo_1.svg/1200px-Brown_Brothers_Harriman_Logo_1.svg.png">
                    </div>

                    <div class="border-t border-gray-100 pt-3">
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Quadrant
                            Labels</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Top Left (High Y, Low X)</label>
                                <input type="text" id="opt-q2" value="HIGHFLIER" class="text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Top Right (High Y, High X)</label>
                                <input type="text" id="opt-q1" value="LEADER" class="text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Bottom Left (Low Y, Low X)</label>
                                <input type="text" id="opt-q3" value="CHALLENGER" class="text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Bottom Right (Low Y, High X)</label>
                                <input type="text" id="opt-q4" value="OUTPERFORMER" class="text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table Column -->
            <div class="glass-panel p-6 shadow-xl w-full">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Company Data</h2>
                    <div class="flex gap-2">
                        <input type="file" id="csv-input" accept=".csv" class="hidden">
                        <button onclick="document.getElementById('csv-input').click()"
                            class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-1 px-3 rounded shadow-sm transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Import CSV
                        </button>
                        <button onclick="exportTableToCSV()"
                            class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-1 px-3 rounded shadow-sm transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export CSV
                        </button>
                    </div>
                </div>

                <div class="overflow-y-auto max-h-[500px] mb-4 space-y-3" id="company-list">
                    <!-- Items will be injected here -->
                </div>

                <!-- Add New Row Form -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Add New Company</h3>
                    <form id="add-company-form" class="space-y-3">
                        <div class="relative">
                            <input type="text" id="input-name" placeholder="Company Name" required class="text-sm"
                                autocomplete="off">
                            <div id="autocomplete-list"
                                class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                                <!-- Dropdown items -->
                            </div>
                        </div>
                        <div>
                            <input type="text" id="input-logo" placeholder="Company Domain (e.g. circle.com)"
                                class="text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Market Strength (0-10)</label>
                                <input type="number" id="input-market" placeholder="8.5" step="0.1" min="0" max="10"
                                    required class="text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Execution Strength (0-10)</label>
                                <input type="number" id="input-execution" placeholder="8.5" step="0.1" min="0" max="10"
                                    required class="text-sm">
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 rounded-md shadow-md transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Add Company
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Chart Config State
        const chartConfig = {
            xAxisLabel: "MARKET STRENGTH",
            yAxisLabel: "EXECUTION STRENGTH",
            q1Label: "LEADER",    // Top Right
            q2Label: "HIGHFLIER", // Top Left
            q3Label: "CHALLENGER",// Bottom Left
            q4Label: "OUTPERFORMER", // Bottom Right
            showBackground: false,
            bgUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Brown_Brothers_Harriman_Logo_1.svg/1200px-Brown_Brothers_Harriman_Logo_1.svg.png",
            // Scaling Defaults
            xMin: 6, xMax: 10, xCrosshair: 8,
            yMin: 7, yMax: 10, yCrosshair: 8.5
        };

        // Initial Data
        let companies = [
            { name: "Circle", domain: "circle.com", market: 9.6, execution: 9.7 },
            { name: "Coinbase", domain: "coinbase.com", market: 9.6, execution: 9.7 },
            { name: "Ripple", domain: "ripple.com", market: 9.7, execution: 9.3 },
            { name: "BitGo", domain: "bitgo.com", market: 9.6, execution: 8.8 },
            { name: "Stellar", domain: "stellar.org", market: 8.4, execution: 8.8 },
            { name: "Bridge", domain: "bridge.xyz", market: 7.9, execution: 8.7 },
            { name: "Aptos Labs", domain: "aptoslabs.com", market: 6.9, execution: 8.7 },
            { name: "Stable", domain: "stable.com", market: 7.2, execution: 8.2 },
            { name: "Bastion", domain: "bastion.com", market: 8.0, execution: 8.2 },
            { name: "Cyclops", domain: "cyclops.xyz", market: 7.8, execution: 7.9 },
            { name: "Omnia Systems", domain: "omniasystems.com", market: 7.9, execution: 7.7 },
            { name: "Zero Hash", domain: "zerohash.com", market: 8.5, execution: 8.6 },
            { name: "Fireblocks", domain: "fireblocks.com", market: 7.5, execution: 8.8 },
            { name: "Paxos", domain: "paxos.com", market: 8.6, execution: 7.9 },
            { name: "1Money", domain: "1money.com", market: 7.4, execution: 8.0 },
            { name: "Anchorage Digital", domain: "anchorage.com", market: 7.3, execution: 7.9 }
        ];

        const chartContainer = document.getElementById('chart');
        const companyList = document.getElementById('company-list');
        const addForm = document.getElementById('add-company-form');
        const titleForm = document.querySelector('#add-company-form').previousElementSibling; // The H3 header
        const btnSubmit = addForm.querySelector('button[type="submit"]');
        const inputName = document.getElementById('input-name');
        const inputLogo = document.getElementById('input-logo');
        const optBg = document.getElementById('opt-bg');
        const optBgUrl = document.getElementById('opt-bg-url');

        // Toggle Background Input Visibility and State
        optBg.addEventListener('change', (e) => {
            chartConfig.showBackground = e.target.checked;
            optBgUrl.style.display = e.target.checked ? 'block' : 'none'; // Toggle input
            renderChart();
        });

        optBgUrl.addEventListener('input', (e) => {
            chartConfig.bgUrl = e.target.value;
            renderChart();
        });

        let editingIndex = null; // Track if we are editing

        // Helper: Get Logo URL Waterfall
        const getBrandfetchUrl = (domain) => `https://asset.brandfetch.io/${domain}?types=icon&formats=png,svg`;
        const getGoogleUrl = (domain) => `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
        const getInitialsUrl = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&rounded=true&bold=true`;

        // Helper: Logo Error Handler / Waterfall
        window.handleLogoError = function (img, domain, name) {
            const currentStep = img.dataset.step;

            // Waterfall Sequence:
            // 1. provided_logo (from API) -> Fail
            // 2. brandfetch -> Fail
            // 3. clearbit_logo -> Fail
            // 4. google -> Fail
            // 5. initials

            if (currentStep === 'provided_logo') {
                if (domain) {
                    img.src = getBrandfetchUrl(domain);
                    img.dataset.step = 'brandfetch';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'brandfetch') {
                if (domain) {
                    img.src = `https://logo.clearbit.com/${domain}`;
                    img.dataset.step = 'clearbit_logo';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'clearbit_logo') {
                if (domain) {
                    img.src = getGoogleUrl(domain);
                    img.dataset.step = 'google';
                } else {
                    img.src = getInitialsUrl(name);
                    img.dataset.step = 'initials';
                }
            } else if (currentStep === 'google') {
                img.src = getInitialsUrl(name);
                img.dataset.step = 'initials';
            }
        };

        // Success Handler: Syncs working URL back to data and redraws chart if needed
        let chartUpdateTimer;
        window.handleLogoSuccess = function (img, name) {
            const company = companies.find(c => c.name === name);
            if (company && company.logo !== img.src) {
                // Only update and re-render if the logo effectively changed
                // (e.g. from null to a resolved URL, or from one URL to a working fallback)
                company.logo = img.src;

                // Debounce chart update to avoid thrashing on initial load
                clearTimeout(chartUpdateTimer);
                chartUpdateTimer = setTimeout(() => {
                    renderChart();
                }, 500);
            }
        };

        // Render Table
        function renderTable() {
            companyList.innerHTML = '';
            companies.forEach((company, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-3 bg-white border border-gray-100 rounded-lg shadow-sm hover:shadow-md transition-shadow group';

                // Initial Logo Source determination
                let startSrc = company.logo;
                let startStep = 'provided_logo';

                if (!startSrc) {
                    if (company.domain) {
                        startSrc = getBrandfetchUrl(company.domain);
                        startStep = 'brandfetch';
                    } else {
                        startSrc = getInitialsUrl(company.name);
                        startStep = 'initials';
                    }
                }

                row.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center overflow-hidden border border-gray-200">
              <img src="${startSrc}" 
                   alt="${company.name}" 
                   class="w-full h-full object-contain p-1" 
                   data-step="${startStep}"
                   onload="handleLogoSuccess(this, '${company.name}')"
                   onerror="handleLogoError(this, '${company.domain || ''}', '${company.name}')">
            </div>
            <div>
              <p class="font-bold text-gray-800 text-sm">${company.name}</p>
              <p class="text-xs text-gray-500">M: ${company.market} | E: ${company.execution}</p>
            </div>
          </div>
          <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="editCompany(${index})" class="text-gray-400 hover:text-indigo-600 p-1" title="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
            <button onclick="deleteCompany(${index})" class="text-gray-400 hover:text-red-500 p-1" title="Remove">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
          </div>
        `;
                companyList.appendChild(row);
            });
        }


        // Render Chart
        function renderChart() {
            chartContainer.innerHTML = '';

            const xCenter = (chartConfig.xMin + chartConfig.xMax) / 2;
            const yCenter = (chartConfig.yMin + chartConfig.yMax) / 2;

            const plot = Plot.plot({
                width: chartContainer.clientWidth,
                height: 600,
                // ... (rest of config)
                x: {
                    domain: [chartConfig.xMin, chartConfig.xMax],
                    axis: null // Hide default axis
                },
                y: {
                    domain: [chartConfig.yMin, chartConfig.yMax],
                    axis: null // Hide default axis
                },
                style: {
                    background: "transparent",
                    fontSize: "14px",
                    fontFamily: "Inter, sans-serif",
                    overflow: "visible"
                },
                marks: [
                    // Dynamic Background Image
                    chartConfig.showBackground && chartConfig.bgUrl ? Plot.image([{ x: xCenter, y: yCenter }], {
                        x: "x",
                        y: "y",
                        src: chartConfig.bgUrl,
                        width: 400, // Fixed width or maybe relative to container?
                        opacity: 0.1,
                        title: "Background Logo"
                    }) : null,

                    Plot.rect([{ x: 0 }], {
                        x1: chartConfig.xMin, x2: chartConfig.xMax,
                        y1: chartConfig.yMin, y2: chartConfig.yMax,
                        rx: 20,
                        stroke: "#9ca3af",
                        strokeWidth: 3,
                        fill: "none"
                    }),

                    Plot.ruleX([chartConfig.xCrosshair], { stroke: "#9ca3af", strokeWidth: 2, y1: chartConfig.yMin, y2: chartConfig.yMax }),
                    Plot.ruleY([chartConfig.yCrosshair], { stroke: "#9ca3af", strokeWidth: 2, x1: chartConfig.xMin, x2: chartConfig.xMax }),

                    Plot.text([{ label: chartConfig.xAxisLabel + " →" }], {
                        x: chartConfig.xCrosshair,
                        y: chartConfig.yMin - (chartConfig.yMax - chartConfig.yMin) * 0.08,
                        text: "label",
                        fill: "#9ca3af",
                        fontSize: 14,
                        fontWeight: "bold"
                    }),
                    Plot.text([{ label: chartConfig.yAxisLabel + " →" }], {
                        x: chartConfig.xMin - (chartConfig.xMax - chartConfig.xMin) * 0.08,
                        y: chartConfig.yCrosshair,
                        text: "label",
                        fill: "#9ca3af",
                        fontSize: 14,
                        fontWeight: "bold",
                        rotate: -90
                    }),

                    Plot.text([{ x: chartConfig.xMin + 0.2, y: chartConfig.yMax - 0.2, label: chartConfig.q2Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "start", pointerEvents: "none" }),
                    Plot.text([{ x: chartConfig.xMax - 0.2, y: chartConfig.yMax - 0.2, label: chartConfig.q1Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "end", pointerEvents: "none" }),
                    Plot.text([{ x: chartConfig.xMin + 0.2, y: chartConfig.yMin + 0.2, label: chartConfig.q3Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "start", pointerEvents: "none" }),
                    Plot.text([{ x: chartConfig.xMax - 0.2, y: chartConfig.yMin + 0.2, label: chartConfig.q4Label }], { x: "x", y: "y", text: "label", fill: "#9ca3af", fontSize: 20, fontWeight: "bold", textAnchor: "end", pointerEvents: "none" }),

                    // 5. Images (Google Favicons -> now robust)
                    Plot.image(companies, {
                        x: "market",
                        y: "execution",
                        src: d => d.logo || getGoogleUrl(d.domain),
                        width: 32,
                        height: 32,
                        title: "name"
                    }),

                    // 6. Tooltips
                    Plot.tip(companies, Plot.pointer({
                        x: "market",
                        y: "execution",
                        title: d => `${d.name}\nMarket Strength: ${d.market}\nExecution Strength: ${d.execution}`,
                        fill: "white",
                        stroke: "#e5e7eb",
                        ariaLabel: "Tooltip",
                        textPadding: 10, // Add some padding
                        opacity: 1, // Ensure opaque
                        style: {
                            color: "#1f2937", // Dark gray text
                            fontSize: "14px",
                            lineHeight: "1.2",
                            boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1)"
                        }
                    }))
                ]
            });

            chartContainer.appendChild(plot);
        }

        // Add / Update Company Logic
        // Add / Update Company Logic
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('input-name').value;
            const domainInput = document.getElementById('input-logo').value; // This is the domain
            const market = parseFloat(document.getElementById('input-market').value);
            const execution = parseFloat(document.getElementById('input-execution').value);

            let logoUrl = null;

            // Auto-discover logo if domain/name present
            if (name) {
                const btnOriginal = btnSubmit.innerHTML;
                btnSubmit.textContent = "Verifying...";
                btnSubmit.disabled = true;

                try {
                    const data = await fetchCompanyData(name);
                    if (data && data.length > 0) {
                        logoUrl = data[0].logo;
                    }
                } catch (err) {
                    console.log("Auto-discovery failed", err);
                }

                // If API didn't give a logo, we rely on domain-based fallbacks in the renderer.
                // We don't need to force Initials here unless we want to lock it in.
                // Better to leave logoUrl null if not found, so renderer waterfall works.

                addOrUpdateCompany(name, domainInput, logoUrl, market, execution);
                resetFormState(btnOriginal);
            }
        });

        function addOrUpdateCompany(name, domain, logo, market, execution) {
            // Auto-scale logic
            let updated = false;
            if (market > chartConfig.xMax) { chartConfig.xMax = Math.ceil(market * 2) / 2; updated = true; }
            if (market < chartConfig.xMin) { chartConfig.xMin = Math.floor(market * 2) / 2; updated = true; }
            if (execution > chartConfig.yMax) { chartConfig.yMax = Math.ceil(execution * 2) / 2; updated = true; }
            if (execution < chartConfig.yMin) { chartConfig.yMin = Math.floor(execution * 2) / 2; updated = true; }

            if (updated) {
                // Sync UI inputs
                document.getElementById('opt-xmax').value = chartConfig.xMax;
                document.getElementById('opt-xmin').value = chartConfig.xMin;
                document.getElementById('opt-ymax').value = chartConfig.yMax;
                document.getElementById('opt-ymin').value = chartConfig.yMin;
            }

            if (editingIndex !== null) {
                // Update existing
                companies[editingIndex] = { name, domain, logo, market, execution };
                editingIndex = null;
                titleForm.textContent = "ADD NEW COMPANY";
            } else {
                // Add new
                companies.push({ name, domain, logo, market, execution });
            }
            renderTable();
            renderChart();
            addForm.reset();
        }

        function resetFormState(originalContent) {
            btnSubmit.innerHTML = originalContent || `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg> Add Company`;
            btnSubmit.disabled = false;

            // Re-apply correct styles based on mode (Add vs Edit reset)
            if (editingIndex === null) {
                btnSubmit.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnSubmit.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        // Edit Company Logic
        window.editCompany = (index) => {
            const company = companies[index];
            document.getElementById('input-name').value = company.name;
            document.getElementById('input-logo').value = company.logo;
            document.getElementById('input-market').value = company.market;
            document.getElementById('input-execution').value = company.execution;

            editingIndex = index;
            titleForm.textContent = "EDIT COMPANY";
            btnSubmit.textContent = "Update Company";
            btnSubmit.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            btnSubmit.classList.add('bg-green-600', 'hover:bg-green-700');
        };

        // Delete Company Logic
        window.deleteCompany = (index) => {
            if (confirm('Are you sure you want to delete this company?')) {
                companies.splice(index, 1);
                // If we were editing this item, cancel edit
                if (editingIndex === index) {
                    addForm.reset();
                    editingIndex = null;
                    titleForm.textContent = "ADD NEW COMPANY";
                    btnSubmit.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Add Company`;
                    btnSubmit.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btnSubmit.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                }
                renderTable();
                renderChart();
            }
        };

        // Logo Autocomplete (Clearbit) - Dropdown Style
        let typingTimer;
        const autocompleteList = document.getElementById('autocomplete-list');

        // Helper: Robust Company Fetch (with Proxy Fallback)
        async function fetchCompanyData(query) {
            const endpoint = `https://autocomplete.clearbit.com/v1/companies/suggest?query=${encodeURIComponent(query)}`;
            // "corsproxy.io" often handles these requests better than allorigins
            const proxyEndpoint = `https://corsproxy.io/?url=${encodeURIComponent(endpoint)}`;

            try {
                // Try direct first
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (err) {
                // console.warn('Direct fetch blocked (CORS/Adblock), trying proxy...');
                try {
                    const response = await fetch(proxyEndpoint);
                    if (!response.ok) throw new Error('Proxy network response was not ok');
                    return await response.json();
                } catch (proxyErr) {
                    console.warn('Logo autocomplete unavailable (likely network blocked). Manual entry required.');
                    return [];
                }
            }
        }

        inputName.addEventListener('input', () => {
            clearTimeout(typingTimer);
            const query = inputName.value;

            if (query.length < 2) {
                autocompleteList.classList.add('hidden');
                return;
            }

            typingTimer = setTimeout(async () => {
                const data = await fetchCompanyData(query);

                autocompleteList.innerHTML = '';
                if (data && data.length > 0) {
                    autocompleteList.classList.remove('hidden');
                    data.forEach(company => {
                        const item = document.createElement('div');

                        // Use unified waterfall logic
                        let startSrc = company.logo;
                        let startStep = 'provided_logo';

                        if (!startSrc) {
                            if (company.domain) {
                                startSrc = getBrandfetchUrl(company.domain);
                                startStep = 'brandfetch';
                            } else {
                                startSrc = getInitialsUrl(company.name);
                                startStep = 'initials';
                            }
                        }

                        item.className = 'flex items-center gap-3 p-2 hover:bg-gray-50 cursor-pointer transition-colors border-b border-gray-50 last:border-0';
                        item.innerHTML = `
                            <div class="w-6 h-6 flex-shrink-0 bg-white rounded-full border border-gray-100 flex items-center justify-center p-0.5 overflow-hidden">
                                <img src="${startSrc}" 
                                   class="w-full h-full object-contain" 
                                   data-step="${startStep}"
                                   onerror="handleLogoError(this, '${company.domain || ''}', '${company.name}')">
                            </div>
                            <span class="text-xs font-medium text-gray-700">${company.name}</span>
                        `;
                        item.addEventListener('click', () => {
                            inputName.value = company.name;
                            inputLogo.value = company.domain; // Populate DOMAIN
                            autocompleteList.classList.add('hidden');
                        });
                        autocompleteList.appendChild(item);
                    });
                } else {
                    autocompleteList.classList.add('hidden');
                }
            }, 300); // 300ms debounce
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!inputName.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.classList.add('hidden');
            }
        });

        // Responsive Redraw
        window.addEventListener('resize', () => {
            renderChart();
        });

        // Export Chart Logic
        window.exportChartImage = async () => {
            const originalNode = document.getElementById('chart');
            if (!originalNode) return;

            // Helper: Fetch image via proxy and convert to Base64
            const toBase64 = async (url) => {
                if (url.startsWith('data:')) return url; // Already base64
                // Use corsproxy.io to bypass CORS
                const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(url)}`;
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (e) {
                    console.warn('Failed to convert image to base64:', url, e);
                    return null; // Keep original or empty on failure
                }
            };

            try {
                const rect = originalNode.getBoundingClientRect();
                const clonedNode = originalNode.cloneNode(true);

                // Ensure the clone has the same dimensions/layout context
                clonedNode.style.width = `${rect.width}px`;
                clonedNode.style.height = `${rect.height}px`;
                clonedNode.style.position = 'fixed'; // Use fixed to avoid affecting document flow
                clonedNode.style.left = '-9999px'; // Move off-screen to hide from user
                clonedNode.style.top = '0';
                clonedNode.style.zIndex = '-9999';
                clonedNode.style.backgroundColor = '#ffffff'; // Force white background on the node itself
                // clonedNode.style.visibility = 'hidden'; // REMOVED: Caused blank export in some browsers/versions

                document.body.appendChild(clonedNode);

                // 2. Find all images in the clone and convert to Base64
                const images = clonedNode.querySelectorAll('image, img');
                const diffs = [];

                for (let img of images) {
                    const src = img.tagName === 'image' ? img.getAttribute('href') : img.getAttribute('src');
                    if (src && (src.startsWith('http') || src.startsWith('//'))) {
                        diffs.push((async () => {
                            const base64 = await toBase64(src);
                            if (base64) {
                                if (img.tagName === 'image') img.setAttribute('href', base64);
                                else img.setAttribute('src', base64);
                            } else {
                                // If failed, remove it so html-to-image doesn't fail on the remote URL
                                img.remove();
                            }
                        })());
                    }
                }

                // Wait for all image conversions
                await Promise.all(diffs);

                // 3. Render the modified clone
                const dataUrl = await htmlToImage.toPng(clonedNode, {
                    backgroundColor: '#ffffff',
                    pixelRatio: 2,
                    skipFonts: true, // Still skip fonts to be safe
                    filter: (node) => node.tagName !== 'BUTTON' // Exclude button (though it's cloned)
                });

                // Cleanup
                document.body.removeChild(clonedNode);

                // 4. Download
                const link = document.createElement('a');
                link.download = `market-heatmap-${new Date().toISOString().slice(0, 10)}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export chart image. ' + error.message);
            }
        };

        // CSV Export Logic
        window.exportTableToCSV = () => {
            const headers = ['name', 'domain', 'market', 'execution'];
            const csvRows = [headers.join(',')];

            companies.forEach(company => {
                const row = [
                    `"${company.name.replace(/"/g, '""')}"`, // Handle quotes in name
                    `"${(company.domain || '').replace(/"/g, '""')}"`,
                    company.market,
                    company.execution
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "companies.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // CSV Import Logic
        const csvInput = document.getElementById('csv-input');
        csvInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.name.split('.').pop().toLowerCase() !== 'csv') {
                alert('Please upload a valid CSV file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const text = event.target.result;
                parseCSV(text);
                csvInput.value = ''; // Reset input
            };
            reader.readAsText(file);
        });

        function parseCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) {
                alert('CSV file appears to be empty or missing data.');
                return;
            }

            // Simple CSV parser assuming "header1,header2" format
            // NOTE: A robust parser would handle commas inside quotes.
            // For this simple use case, we will assume standard CSVs or use a basic regex split if needed.
            // Let's try to detect headers.
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));

            const nameIdx = headers.indexOf('name');
            const domainIdx = headers.indexOf('domain');
            const marketIdx = headers.indexOf('market');
            const execIdx = headers.indexOf('execution');

            if (nameIdx === -1 || marketIdx === -1 || execIdx === -1) {
                alert('CSV must contain "name", "market", and "execution" columns.');
                return;
            }

            let addedCount = 0;
            for (let i = 1; i < lines.length; i++) {
                // Handle basic comma split, respecting quotes is harder without a lib, 
                // but we can try a regex split or just split by comma if we assume simple data.
                // Regex for splitting by comma but ignoring commas within quotes:
                const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                // Fallback for simple split if regex misses (e.g. empty fields)
                // A safer simple approach for now:
                const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));

                if (cols.length < headers.length) continue;

                const name = cols[nameIdx];
                const domain = domainIdx !== -1 ? cols[domainIdx] : '';
                const market = parseFloat(cols[marketIdx]);
                const execution = parseFloat(cols[execIdx]);

                if (name && !isNaN(market) && !isNaN(execution)) {
                    // Check if exists? Optional. Let's just add for now or update?
                    // Let's push to array.
                    companies.push({
                        name,
                        domain,
                        market,
                        execution,
                        logo: domain ? getBrandfetchUrl(domain) : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`
                    });
                    addedCount++;
                }
            }

            if (addedCount > 0) {
                renderTable();
                renderChart();
                alert(`Successfully imported ${addedCount} companies.`);
            } else {
                alert('No valid companies found to import.');
            }
        }

        // Options Logic
        function toggleOptions() {
            const content = document.getElementById('options-content');
            const chevron = document.getElementById('options-chevron');
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // Bind Options Inputs
        ['opt-xaxis', 'opt-yaxis', 'opt-q1', 'opt-q2', 'opt-q3', 'opt-q4'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = e.target.value;
                if (id === 'opt-xaxis') chartConfig.xAxisLabel = val;
                if (id === 'opt-yaxis') chartConfig.yAxisLabel = val;
                if (id === 'opt-q1') chartConfig.q1Label = val;
                if (id === 'opt-q2') chartConfig.q2Label = val;
                if (id === 'opt-q3') chartConfig.q3Label = val;
                if (id === 'opt-q4') chartConfig.q4Label = val;
                renderChart();
            });
        });

        // Scaling Inputs
        ['opt-xmin', 'opt-xmax', 'opt-xcross', 'opt-ymin', 'opt-ymax', 'opt-ycross'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                if (isNaN(val)) return;

                if (id === 'opt-xmin') chartConfig.xMin = val;
                if (id === 'opt-xmax') chartConfig.xMax = val;
                if (id === 'opt-xcross') chartConfig.xCrosshair = val;

                if (id === 'opt-ymin') chartConfig.yMin = val;
                if (id === 'opt-ymax') chartConfig.yMax = val;
                if (id === 'opt-ycross') chartConfig.yCrosshair = val;

                renderChart();
            });
        });

        // Background Toggle
        document.getElementById('opt-bg').addEventListener('change', (e) => {
            chartConfig.showBackground = e.target.checked;
            renderChart();
        });

        // Init
        renderTable();
        renderChart();
    </script>
</body>

</html>